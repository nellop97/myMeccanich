<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">

    <!-- ========== CHANGESET 1: TABELLE PRINCIPALI ========== -->
    
    <changeSet id="1" author="carmanagement">
        <comment>Creazione tabelle principali del sistema</comment>
        
        <!-- Tabella Users -->
        <createTable tableName="users">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="password" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="first_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="last_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="phone_number" type="VARCHAR(20)"/>
            <column name="role" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="address" type="VARCHAR(255)"/>
            <column name="city" type="VARCHAR(100)"/>
            <column name="postal_code" type="VARCHAR(10)"/>
            <column name="fiscal_code" type="VARCHAR(16)"/>
            <column name="vat_number" type="VARCHAR(11)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabella Vehicle Models -->
        <createTable tableName="vehicle_models">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="brand" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="model" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="generation" type="VARCHAR(50)"/>
            <column name="year_from" type="INTEGER"/>
            <column name="year_to" type="INTEGER"/>
        </createTable>
        
        <!-- Tabella Vehicles -->
        <createTable tableName="vehicles">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="license_plate" type="VARCHAR(10)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="vin" type="VARCHAR(17)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="vehicle_model_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="owner_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="year" type="INTEGER"/>
            <column name="color" type="VARCHAR(50)"/>
            <column name="mileage" type="INTEGER"/>
            <column name="engine_code" type="VARCHAR(20)"/>
            <column name="fuel_type" type="VARCHAR(20)"/>
            <column name="registration_date" type="DATE"/>
            <column name="last_inspection_date" type="DATE"/>
            <column name="next_inspection_date" type="DATE"/>
            <column name="insurance_expiry_date" type="DATE"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabella Workshops -->
        <createTable tableName="workshops">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="owner_id" type="BIGINT">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="address" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="city" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="postal_code" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="phone_number" type="VARCHAR(20)"/>
            <column name="email" type="VARCHAR(255)"/>
            <column name="website" type="VARCHAR(255)"/>
            <column name="vat_number" type="VARCHAR(11)"/>
            <column name="business_license" type="VARCHAR(100)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabella Workshop Service Types (many-to-many) -->
        <createTable tableName="workshop_service_types">
            <column name="workshop_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="service_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabella Maintenance Records -->
        <createTable tableName="maintenance_records">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="vehicle_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="workshop_id" type="BIGINT"/>
            <column name="mechanic_id" type="BIGINT"/>
            <column name="service_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="mileage_at_service" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(1000)">
                <constraints nullable="false"/>
            </column>
            <column name="notes" type="VARCHAR(2000)"/>
            <column name="cost" type="DECIMAL(10,2)"/>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="next_service_date" type="DATE"/>
            <column name="next_service_mileage" type="INTEGER"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabella Used Parts -->
        <createTable tableName="used_parts">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="maintenance_record_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="part_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="part_number" type="VARCHAR(100)"/>
            <column name="brand" type="VARCHAR(100)"/>
            <column name="quantity" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="unit_price" type="DECIMAL(10,2)"/>
            <column name="total_price" type="DECIMAL(10,2)"/>
        </createTable>
        
        <!-- Tabella Invoices -->
        <createTable tableName="invoices">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="invoice_number" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="workshop_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="customer_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="maintenance_record_id" type="BIGINT"/>
            <column name="issue_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="due_date" type="DATE"/>
            <column name="subtotal" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="vat_rate" type="DECIMAL(5,2)">
                <constraints nullable="false"/>
            </column>
            <column name="vat_amount" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="total" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="paid_date" type="DATE"/>
            <column name="payment_method" type="VARCHAR(20)"/>
            <column name="notes" type="VARCHAR(1000)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabella Invoice Items -->
        <createTable tableName="invoice_items">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="invoice_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="unit_price" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="total_price" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="item_type" type="VARCHAR(20)"/>
        </createTable>
        
        <!-- Tabella Reminders -->
        <createTable tableName="reminders">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="vehicle_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(1000)"/>
            <column name="type" type="VARCHAR(30)">
                <constraints nullable="false"/>
            </column>
            <column name="reminder_date" type="DATE"/>
            <column name="reminder_mileage" type="INTEGER"/>
            <column name="is_active" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="is_recurring" type="BOOLEAN"/>
            <column name="recurring_interval_days" type="INTEGER"/>
            <column name="recurring_interval_mileage" type="INTEGER"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!-- ========== CHANGESET 2: FOREIGN KEYS ========== -->
    
    <changeSet id="2" author="carmanagement">
        <comment>Aggiunta foreign keys</comment>
        
        <!-- Foreign Keys per Vehicles -->
        <addForeignKeyConstraint
            baseTableName="vehicles"
            baseColumnNames="vehicle_model_id"
            constraintName="fk_vehicles_model"
            referencedTableName="vehicle_models"
            referencedColumnNames="id"
            onDelete="RESTRICT"
            onUpdate="CASCADE"/>
            
        <addForeignKeyConstraint
            baseTableName="vehicles"
            baseColumnNames="owner_id"
            constraintName="fk_vehicles_owner"
            referencedTableName="users"
            referencedColumnNames="id"
            onDelete="RESTRICT"
            onUpdate="CASCADE"/>
        
        <!-- Foreign Keys per Workshops -->
        <addForeignKeyConstraint
            baseTableName="workshops"
            baseColumnNames="owner_id"
            constraintName="fk_workshops_owner"
            referencedTableName="users"
            referencedColumnNames="id"
            onDelete="RESTRICT"
            onUpdate="CASCADE"/>
        
        <!-- Foreign Keys per Workshop Service Types -->
        <addForeignKeyConstraint
            baseTableName="workshop_service_types"
            baseColumnNames="workshop_id"
            constraintName="fk_workshop_services_workshop"
            referencedTableName="workshops"
            referencedColumnNames="id"
            onDelete="CASCADE"
            onUpdate="CASCADE"/>
        
        <!-- Foreign Keys per Maintenance Records -->
        <addForeignKeyConstraint
            baseTableName="maintenance_records"
            baseColumnNames="vehicle_id"
            constraintName="fk_maintenance_vehicle"
            referencedTableName="vehicles"
            referencedColumnNames="id"
            onDelete="RESTRICT"
            onUpdate="CASCADE"/>
            
        <addForeignKeyConstraint
            baseTableName="maintenance_records"
            baseColumnNames="workshop_id"
            constraintName="fk_maintenance_workshop"
            referencedTableName="workshops"
            referencedColumnNames="id"
            onDelete="SET NULL"
            onUpdate="CASCADE"/>
            
        <addForeignKeyConstraint
            baseTableName="maintenance_records"
            baseColumnNames="mechanic_id"
            constraintName="fk_maintenance_mechanic"
            referencedTableName="users"
            referencedColumnNames="id"
            onDelete="SET NULL"
            onUpdate="CASCADE"/>
        
        <!-- Foreign Keys per Used Parts -->
        <addForeignKeyConstraint
            baseTableName="used_parts"
            baseColumnNames="maintenance_record_id"
            constraintName="fk_parts_maintenance"
            referencedTableName="maintenance_records"
            referencedColumnNames="id"
            onDelete="CASCADE"
            onUpdate="CASCADE"/>
        
        <!-- Foreign Keys per Invoices -->
        <addForeignKeyConstraint
            baseTableName="invoices"
            baseColumnNames="workshop_id"
            constraintName="fk_invoices_workshop"
            referencedTableName="workshops"
            referencedColumnNames="id"
            onDelete="RESTRICT"
            onUpdate="CASCADE"/>
            
        <addForeignKeyConstraint
            baseTableName="invoices"
            baseColumnNames="customer_id"
            constraintName="fk_invoices_customer"
            referencedTableName="users"
            referencedColumnNames="id"
            onDelete="RESTRICT"
            onUpdate="CASCADE"/>
            
        <addForeignKeyConstraint
            baseTableName="invoices"
            baseColumnNames="maintenance_record_id"
            constraintName="fk_invoices_maintenance"
            referencedTableName="maintenance_records"
            referencedColumnNames="id"
            onDelete="SET NULL"
            onUpdate="CASCADE"/>
        
        <!-- Foreign Keys per Invoice Items -->
        <addForeignKeyConstraint
            baseTableName="invoice_items"
            baseColumnNames="invoice_id"
            constraintName="fk_items_invoice"
            referencedTableName="invoices"
            referencedColumnNames="id"
            onDelete="CASCADE"
            onUpdate="CASCADE"/>
        
        <!-- Foreign Keys per Reminders -->
        <addForeignKeyConstraint
            baseTableName="reminders"
            baseColumnNames="vehicle_id"
            constraintName="fk_reminders_vehicle"
            referencedTableName="vehicles"
            referencedColumnNames="id"
            onDelete="CASCADE"
            onUpdate="CASCADE"/>
            
        <addForeignKeyConstraint
            baseTableName="reminders"
            baseColumnNames="user_id"
            constraintName="fk_reminders_user"
            referencedTableName="users"
            referencedColumnNames="id"
            onDelete="CASCADE"
            onUpdate="CASCADE"/>
    </changeSet>

    <!-- ========== CHANGESET 3: INDICI ========== -->
    
    <changeSet id="3" author="carmanagement">
        <comment>Creazione indici per performance</comment>
        
        <!-- Indici per Users -->
        <createIndex tableName="users" indexName="idx_users_email">
            <column name="email"/>
        </createIndex>
        <createIndex tableName="users" indexName="idx_users_role">
            <column name="role"/>
        </createIndex>
        <createIndex tableName="users" indexName="idx_users_fiscal_code">
            <column name="fiscal_code"/>
        </createIndex>
        
        <!-- Indici per Vehicle Models -->
        <createIndex tableName="vehicle_models" indexName="idx_models_brand">
            <column name="brand"/>
        </createIndex>
        <createIndex tableName="vehicle_models" indexName="idx_models_brand_model">
            <column name="brand"/>
            <column name="model"/>
        </createIndex>
        
        <!-- Indici per Vehicles -->
        <createIndex tableName="vehicles" indexName="idx_vehicles_license_plate">
            <column name="license_plate"/>
        </createIndex>
        <createIndex tableName="vehicles" indexName="idx_vehicles_vin">
            <column name="vin"/>
        </createIndex>
        <createIndex tableName="vehicles" indexName="idx_vehicles_owner">
            <column name="owner_id"/>
        </createIndex>
        <createIndex tableName="vehicles" indexName="idx_vehicles_inspection_date">
            <column name="next_inspection_date"/>
        </createIndex>
        <createIndex tableName="vehicles" indexName="idx_vehicles_insurance_date">
            <column name="insurance_expiry_date"/>
        </createIndex>
        
        <!-- Indici per Workshops -->
        <createIndex tableName="workshops" indexName="idx_workshops_city">
            <column name="city"/>
        </createIndex>
        <createIndex tableName="workshops" indexName="idx_workshops_owner">
            <column name="owner_id"/>
        </createIndex>
        
        <!-- Indici per Maintenance Records -->
        <createIndex tableName="maintenance_records" indexName="idx_maintenance_vehicle">
            <column name="vehicle_id"/>
        </createIndex>
        <createIndex tableName="maintenance_records" indexName="idx_maintenance_workshop">
            <column name="workshop_id"/>
        </createIndex>
        <createIndex tableName="maintenance_records" indexName="idx_maintenance_mechanic">
            <column name="mechanic_id"/>
        </createIndex>
        <createIndex tableName="maintenance_records" indexName="idx_maintenance_date">
            <column name="service_date"/>
        </createIndex>
        <createIndex tableName="maintenance_records" indexName="idx_maintenance_status">
            <column name="status"/>
        </createIndex>
        <createIndex tableName="maintenance_records" indexName="idx_maintenance_next_service">
            <column name="next_service_date"/>
        </createIndex>
        
        <!-- Indici per Invoices -->
        <createIndex tableName="invoices" indexName="idx_invoices_workshop">
            <column name="workshop_id"/>
        </createIndex>
        <createIndex tableName="invoices" indexName="idx_invoices_customer">
            <column name="customer_id"/>
        </createIndex>
        <createIndex tableName="invoices" indexName="idx_invoices_status">
            <column name="status"/>
        </createIndex>
        <createIndex tableName="invoices" indexName="idx_invoices_due_date">
            <column name="due_date"/>
        </createIndex>
        <createIndex tableName="invoices" indexName="idx_invoices_issue_date">
            <column name="issue_date"/>
        </createIndex>
        
        <!-- Indici per Reminders -->
        <createIndex tableName="reminders" indexName="idx_reminders_user">
            <column name="user_id"/>
        </createIndex>
        <createIndex tableName="reminders" indexName="idx_reminders_vehicle">
            <column name="vehicle_id"/>
        </createIndex>
        <createIndex tableName="reminders" indexName="idx_reminders_date">
            <column name="reminder_date"/>
        </createIndex>
        <createIndex tableName="reminders" indexName="idx_reminders_active">
            <column name="is_active"/>
        </createIndex>
        <createIndex tableName="reminders" indexName="idx_reminders_type">
            <column name="type"/>
        </createIndex>
    </changeSet>

    <!-- ========== CHANGESET 4: CONSTRAINTS E CHECK ========== -->
    
    <changeSet id="4" author="carmanagement">
        <comment>Aggiunta constraints e validazioni</comment>
        
        <!-- Check constraints per Users -->
        <sql>
            ALTER TABLE users ADD CONSTRAINT chk_users_role 
            CHECK (role IN ('VEHICLE_OWNER', 'MECHANIC', 'WORKSHOP_ADMIN'));
        </sql>
        
        <!-- Check constraints per Maintenance Records -->
        <sql>
            ALTER TABLE maintenance_records ADD CONSTRAINT chk_maintenance_type
            CHECK (type IN ('ROUTINE_SERVICE', 'BRAKE_SERVICE', 'ENGINE_REPAIR', 'TRANSMISSION_REPAIR', 
                           'ELECTRICAL_REPAIR', 'TIRE_CHANGE', 'BATTERY_REPLACEMENT', 'OIL_CHANGE', 
                           'FILTER_REPLACEMENT', 'BELT_REPLACEMENT', 'INSPECTION', 'BODYWORK', 'OTHER'));
        </sql>
        
        <sql>
            ALTER TABLE maintenance_records ADD CONSTRAINT chk_maintenance_status
            CHECK (status IN ('SCHEDULED', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED'));
        </sql>
        
        <sql>
            ALTER TABLE maintenance_records ADD CONSTRAINT chk_maintenance_mileage
            CHECK (mileage_at_service >= 0);
        </sql>
        
        <!-- Check constraints per Workshop Service Types -->
        <sql>
            ALTER TABLE workshop_service_types ADD CONSTRAINT chk_service_type
            CHECK (service_type IN ('GENERAL_REPAIR', 'ENGINE_SPECIALIST', 'BRAKE_SPECIALIST', 
                                   'ELECTRICAL_SPECIALIST', 'BODYWORK', 'TIRE_SERVICE', 
                                   'INSPECTION_SERVICE', 'EMERGENCY_SERVICE'));
        </sql>
        
        <!-- Check constraints per Invoices -->
        <sql>
            ALTER TABLE invoices ADD CONSTRAINT chk_invoice_status
            CHECK (status IN ('DRAFT', 'SENT', 'PAID', 'OVERDUE', 'CANCELLED'));
        </sql>
        
        <sql>
            ALTER TABLE invoices ADD CONSTRAINT chk_payment_method
            CHECK (payment_method IN ('CASH', 'BANK_TRANSFER', 'CREDIT_CARD', 'DEBIT_CARD', 'CHECK'));
        </sql>
        
        <sql>
            ALTER TABLE invoices ADD CONSTRAINT chk_invoice_amounts
            CHECK (subtotal >= 0 AND vat_rate >= 0 AND vat_amount >= 0 AND total >= 0);
        </sql>
        
        <!-- Check constraints per Invoice Items -->
        <sql>
            ALTER TABLE invoice_items ADD CONSTRAINT chk_item_type
            CHECK (item_type IN ('LABOR', 'PART', 'SERVICE', 'OTHER'));
        </sql>
        
        <sql>
            ALTER TABLE invoice_items ADD CONSTRAINT chk_item_amounts
            CHECK (quantity > 0 AND unit_price >= 0 AND total_price >= 0);
        </sql>
        
        <!-- Check constraints per Used Parts -->
        <sql>
            ALTER TABLE used_parts ADD CONSTRAINT chk_part_amounts
            CHECK (quantity > 0 AND (unit_price IS NULL OR unit_price >= 0) 
                   AND (total_price IS NULL OR total_price >= 0));
        </sql>
        
        <!-- Check constraints per Reminders -->
        <sql>
            ALTER TABLE reminders ADD CONSTRAINT chk_reminder_type
            CHECK (type IN ('MAINTENANCE_DUE', 'INSPECTION_DUE', 'INSURANCE_EXPIRY', 
                           'REGISTRATION_RENEWAL', 'TIRE_ROTATION', 'OIL_CHANGE', 'CUSTOM'));
        </sql>
        
        <!-- Check constraints per Vehicles -->
        <sql>
            ALTER TABLE vehicles ADD CONSTRAINT chk_vehicle_mileage
            CHECK (mileage IS NULL OR mileage >= 0);
        </sql>
        
        <sql>
            ALTER TABLE vehicles ADD CONSTRAINT chk_vehicle_year
            CHECK (year IS NULL OR (year >= 1900 AND year <= 2030));
        </sql>
    </changeSet>

    <!-- ========== CHANGESET 5: FUNZIONI E TRIGGER ========== -->
    
    <changeSet id="5" author="carmanagement">
        <comment>Funzioni e trigger per updated_at automatico</comment>
        
        <!-- Funzione per aggiornare updated_at -->
        <sql>
            CREATE OR REPLACE FUNCTION update_updated_at_column()
            RETURNS TRIGGER AS $$
            BEGIN
                NEW.updated_at = CURRENT_TIMESTAMP;
                RETURN NEW;
            END;
            $$ language 'plpgsql';
        </sql>
        
        <!-- Trigger per Users -->
        <sql>
            CREATE TRIGGER update_users_updated_at 
            BEFORE UPDATE ON users 
            FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
        </sql>
        
        <!-- Trigger per Vehicles -->
        <sql>
            CREATE TRIGGER update_vehicles_updated_at 
            BEFORE UPDATE ON vehicles 
            FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
        </sql>
        
        <!-- Trigger per Workshops -->
        <sql>
            CREATE TRIGGER update_workshops_updated_at 
            BEFORE UPDATE ON workshops 
            FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
        </sql>
        
        <!-- Trigger per Maintenance Records -->
        <sql>
            CREATE TRIGGER update_maintenance_updated_at 
            BEFORE UPDATE ON maintenance_records 
            FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
        </sql>
        
        <!-- Trigger per Invoices -->
        <sql>
            CREATE TRIGGER update_invoices_updated_at 
            BEFORE UPDATE ON invoices 
            FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
        </sql>
        
        <!-- Trigger per Reminders -->
        <sql>
            CREATE TRIGGER update_reminders_updated_at 
            BEFORE UPDATE ON reminders 
            FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
        </sql>
    </changeSet>

    <!-- ========== CHANGESET 6: DATI DI BASE ========== -->
    
    <changeSet id="6" author="carmanagement">
        <comment>Inserimento dati di base per vehicle models</comment>
        
        <!-- Modelli Audi -->
        <insert tableName="vehicle_models">
            <column name="brand" value="Audi"/>
            <column name="model" value="A3"/>
            <column name="generation" value="8Y"/>
            <column name="year_from" valueNumeric="2020"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Audi"/>
            <column name="model" value="A4"/>
            <column name="generation" value="B9"/>
            <column name="year_from" valueNumeric="2015"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Audi"/>
            <column name="model" value="A6"/>
            <column name="generation" value="C8"/>
            <column name="year_from" valueNumeric="2018"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Audi"/>
            <column name="model" value="Q3"/>
            <column name="generation" value="8U"/>
            <column name="year_from" valueNumeric="2018"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Audi"/>
            <column name="model" value="Q5"/>
            <column name="generation" value="FY"/>
            <column name="year_from" valueNumeric="2016"/>
        </insert>
        
        <!-- Modelli BMW -->
        <insert tableName="vehicle_models">
            <column name="brand" value="BMW"/>
            <column name="model" value="Serie 1"/>
            <column name="generation" value="F40"/>
            <column name="year_from" valueNumeric="2019"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="BMW"/>
            <column name="model" value="Serie 3"/>
            <column name="generation" value="G20"/>
            <column name="year_from" valueNumeric="2018"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="BMW"/>
            <column name="model" value="Serie 5"/>
            <column name="generation" value="G30"/>
            <column name="year_from" valueNumeric="2016"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="BMW"/>
            <column name="model" value="X1"/>
            <column name="generation" value="F48"/>
            <column name="year_from" valueNumeric="2015"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="BMW"/>
            <column name="model" value="X3"/>
            <column name="generation" value="G01"/>
            <column name="year_from" valueNumeric="2017"/>
        </insert>
        
        <!-- Modelli Mercedes-Benz -->
        <insert tableName="vehicle_models">
            <column name="brand" value="Mercedes-Benz"/>
            <column name="model" value="Classe A"/>
            <column name="generation" value="W177"/>
            <column name="year_from" valueNumeric="2018"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Mercedes-Benz"/>
            <column name="model" value="Classe C"/>
            <column name="generation" value="W206"/>
            <column name="year_from" valueNumeric="2021"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Mercedes-Benz"/>
            <column name="model" value="Classe E"/>
            <column name="generation" value="W213"/>
            <column name="year_from" valueNumeric="2016"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Mercedes-Benz"/>
            <column name="model" value="GLA"/>
            <column name="generation" value="H247"/>
            <column name="year_from" valueNumeric="2020"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Mercedes-Benz"/>
            <column name="model" value="GLC"/>
            <column name="generation" value="C253"/>
            <column name="year_from" valueNumeric="2015"/>
        </insert>
        
        <!-- Modelli Volkswagen -->
        <insert tableName="vehicle_models">
            <column name="brand" value="Volkswagen"/>
            <column name="model" value="Golf"/>
            <column name="generation" value="Mk8"/>
            <column name="year_from" valueNumeric="2019"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Volkswagen"/>
            <column name="model" value="Passat"/>
            <column name="generation" value="B8"/>
            <column name="year_from" valueNumeric="2014"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Volkswagen"/>
            <column name="model" value="Tiguan"/>
            <column name="generation" value="5N"/>
            <column name="year_from" valueNumeric="2016"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Volkswagen"/>
            <column name="model" value="Polo"/>
            <column name="generation" value="AW"/>
            <column name="year_from" valueNumeric="2017"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Volkswagen"/>
            <column name="model" value="T-Cross"/>
            <column name="generation" value="C1"/>
            <column name="year_from" valueNumeric="2018"/>
        </insert>
        
        <!-- Modelli Fiat -->
        <insert tableName="vehicle_models">
            <column name="brand" value="Fiat"/>
            <column name="model" value="500"/>
            <column name="generation" value="312"/>
            <column name="year_from" valueNumeric="2007"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Fiat"/>
            <column name="model" value="Panda"/>
            <column name="generation" value="319"/>
            <column name="year_from" valueNumeric="2011"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Fiat"/>
            <column name="model" value="Punto"/>
            <column name="generation" value="199"/>
            <column name="year_from" valueNumeric="2005"/>
            <column name="year_to" valueNumeric="2018"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Fiat"/>
            <column name="model" value="Tipo"/>
            <column name="generation" value="356"/>
            <column name="year_from" valueNumeric="2015"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Fiat"/>
            <column name="model" value="500X"/>
            <column name="generation" value="334"/>
            <column name="year_from" valueNumeric="2014"/>
        </insert>
        
        <!-- Modelli Ford -->
        <insert tableName="vehicle_models">
            <column name="brand" value="Ford"/>
            <column name="model" value="Fiesta"/>
            <column name="generation" value="Mk8"/>
            <column name="year_from" valueNumeric="2017"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Ford"/>
            <column name="model" value="Focus"/>
            <column name="generation" value="Mk4"/>
            <column name="year_from" valueNumeric="2018"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Ford"/>
            <column name="model" value="Kuga"/>
            <column name="generation" value="C520"/>
            <column name="year_from" valueNumeric="2019"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Ford"/>
            <column name="model" value="Puma"/>
            <column name="generation" value="JK"/>
            <column name="year_from" valueNumeric="2019"/>
        </insert>
        
        <!-- Modelli Renault -->
        <insert tableName="vehicle_models">
            <column name="brand" value="Renault"/>
            <column name="model" value="Clio"/>
            <column name="generation" value="V"/>
            <column name="year_from" valueNumeric="2019"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Renault"/>
            <column name="model" value="Megane"/>
            <column name="generation" value="IV"/>
            <column name="year_from" valueNumeric="2015"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Renault"/>
            <column name="model" value="Captur"/>
            <column name="generation" value="II"/>
            <column name="year_from" valueNumeric="2019"/>
        </insert>
        <insert tableName="vehicle_models">
            <column name="brand" value="Renault"/>
            <column name="model" value="Kadjar"/>
            <column name="generation" value="I"/>
            <column name="year_from" valueNumeric="2015"/>
        </insert>
    </changeSet>

    <!-- ========== CHANGESET 7: UTENTE ADMIN DI DEFAULT ========== -->
    
    <changeSet id="7" author="carmanagement">
        <comment>Creazione utente amministratore di default</comment>
        
        <insert tableName="users">
            <column name="email" value="admin@carmanagement.com"/>
            <column name="password" value="$2a$10$N4p8q.P8n0x6qbQzO.g6Dej0B3xh8Ixl/9dGjOt1L9K8eQf3MwqVW"/> <!-- password: admin123 -->
            <column name="first_name" value="Admin"/>
            <column name="last_name" value="Sistema"/>
            <column name="role" value="WORKSHOP_ADMIN"/>
            <column name="address" value="Via Roma 1"/>
            <column name="city" value="Milano"/>
            <column name="postal_code" value="20100"/>
            <column name="fiscal_code" value="DMNSST80A01F205X"/>
        </insert>
    </changeSet>

</databaseChangeLog>